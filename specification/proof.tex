% Copyright 2018 Google LLC
%
% Use of this source code is governed by an MIT-style
% license that can be found in the LICENSE file or at
% https://opensource.org/licenses/MIT.

%!TeX spellcheck = en-US

\documentclass[eprint.tex]{subfiles}
\begin{document}
\section{Security reduction}
\subsection{Definitions}
HBSH mode relies on a two-input $\epsilon$-almost-$\Delta$-universal function and
block and stream cipher primitives, and we define their security properties
as follows. In what follows we draw on definitions used in \cite{hctr2}.

\parintro{Hash function $H$}
We require the hash function
$H: \mathcal{K}_H \times \mathcal{T} \times \mathcal{L} \rightarrow \bin^n$
to be $\epsilon$-almost-$\Delta$-universal for some $\epsilon$:
for any $g \in \bin^n$ and
any two distinct messages $(T, L) \neq (T', L')$:
%
\begin{displaymath}
\prob{H_{K}(T, L) \boxminus H_{K}(T', L') = g | K \sample \mathcal{K}_H} \leq \epsilon
\end{displaymath}
%
For Adiantum and HPolyC the value of $\epsilon$ will depend on bounds on the lengths of $T$ and $L$.

\parintro{Stream cipher $S$}
We require the stream cipher
$S: \mathcal{K}_S \times \mathcal{N} \rightarrow \bin^{l_S}$
to be a pseudorandom function. $\mathcal{N} \rightarrow \bin^{l_S}$ denotes the set of all
functions from $\mathcal{N}$ to $\bin^{l_S}$, and we
define the distinguishing advantage of an adversary A as follows.
%
\begin{displaymath}
    \begin{aligned}
        \advantage{\mathrm{prf}}{S}[(A)] =
        &\left| \prob{A^S\Rightarrow 1 | K \sample \mathcal{K}_S}\right.
        \\
        &\left. - \prob{A^F\Rightarrow 1
        | F \sample (\mathcal{N} \rightarrow \bin^{l_S})} \right|
    \end{aligned}
\end{displaymath}
%
We define $\advantage{\mathrm{prf}}{S}[(q, l, t)]$ to be
$\max_{A \in \mathcal{A}(q, l, t)} \advantage{\mathrm{prf}}{S}[(A)]$ where $\mathcal{A}(q, l, t)$
is the set of all adversaries that make at most $q$ queries, discard all but $l$ bits from
the results of those queries, and take at most $t$ time.

\parintro{Block cipher $E$}
We require the block cipher
$E: \mathcal{K}_E \times \bin^n \rightarrow \bin^n$
to be a super-pseudorandom permutation.
Let $\Perm(S)$ denote the set of all permutations on a set $S$; then we define the distinguishing
advantage of an adversary A as follows.
%
\begin{displaymath}
    \begin{aligned}
        \advantage{\pm \mathrm{prp}}{E}[(A)] =
        &\left|\prob{A^{E_K,E_K^{-1}}\Rightarrow 1 | K \sample \mathcal{K}_E}\right.
        \\
        &\left. - \prob{A^{\pi,\pi^{-1}}\Rightarrow 1
            | \pi \sample \Perm(\bin^n)}\right|
    \end{aligned}
\end{displaymath}
%
We define $\advantage{\pm \mathrm{prp}}{E}[(q, t)]$ to be
$\max_{A \in \mathcal{A}(q, t)} \advantage{\pm \mathrm{prp}}{E}[(A)]$ where $\mathcal{A}(q, t)$
is the set of all adversaries that make at most $q$ queries and take at most $t$ time.

\parintro{HBSH}
HBSH itself is a tweakable length-preserving encryption system.
Let $\Perm^\mathcal{T}(\mathcal{M})$ denote the set of all functions
$\bm{\pi} : \mathcal{T} \times \mathcal{M} \rightarrow \mathcal{M}$
such that for all $T \in \mathcal{T}$,
$\bm{\pi}_{T}$ is a length-preserving permutation: ie
$|\bm{\pi}(T, M)| = |M|$ for all $M \in \mathcal{M}$,
and $\bm{\pi}_{T}^{-1}$ exists.
In an abuse of notation, we use $\bm{\pi}^{-1}$ to refer to the function
such that $\bm{\pi}^{-1}(T, \bm{\pi}(T, M)) = M$ ie $(\bm{\pi}^{-1})_T = (\bm{\pi}_T)^{-1}$.
For a tweakable length-preserving encryption system
$\bm{E} : \mathcal{K} \times \mathcal{T} \times \mathcal{M} \rightarrow \mathcal{M}$, we
define $A$'s distinguishing advantage as:
%
\begin{displaymath}
    \begin{aligned}
        \advantage{\pm \widetilde{\mathrm{prp}}}{\bm{E}}[(A)] =
        &\left|\prob{A^{\bm{E}_K,\bm{E}_K^{-1}}\Rightarrow 1 | K \sample \mathcal{K}}\right.
        \\
        &\left. - \prob{A^{\bm{\pi},\bm{\pi}^{-1}}\Rightarrow 1
            | \bm{\pi} \sample \Perm^\mathcal{T}(\mathcal{M})}\right|
    \end{aligned}
\end{displaymath}
%
We define $\advantage{\pm \widetilde{\mathrm{prp}}}{\bm{E}}[(q, l_T, l_M, t)]$
to be
$\max_{A \in \mathcal{A}(q, l_T, l_M, t)} \advantage{\pm \widetilde{\mathrm{prp}}}{\bm{E}}[(A)]$
where $\mathcal{A}(q, l_T, l_M, t)$
is the set of all adversaries that
make at most $q$ queries
with tweak of length at most $l_T$
and message of length at most $l_M$
and take at most $t$ time.

\subsection{Primary claim}
\begin{theorem}\label{hbshadvantage}
    Where HBSH mode is instantiated with hash function $H$, block cipher $E$ and stream cipher $S$,
    and where $H$ is $\epsilon$-almost-$\Delta$-universal for inputs such that
    $|T| \leq l_T$, $|L| \leq l_M - n$, then:
    %
    \begin{align*}
        &\advantage{\pm \widetilde{\mathrm{prp}}}{\HBSH}[(q, l_T, l_M, t)] \\
        \leq& \advantage{\pm \mathrm{prp}}{E}[(q, t')] \\
        +& \advantage{\mathrm{prf}}{S}[(q + 1, |K_E| + |K_H| + q(l_M - n), t')] \\
        +& (\epsilon + 2(2^{-n}))\binom{q}{2} \\
    \end{align*}
    %
    where $t' = t + \bigO{q(l_T + l_M)}$.
\end{theorem}

\subsection{Preliminaries}
\parintro{Helper functions}
We define here
helper functions $\xi$, $\theta$, $\phi$, and $\eta$, useful for constructing
HBSH-like ciphers. Where a parameter is given as
$L || R$, $|R|=n$.

\begin{align*}
    \xi :& \mathcal{K}_H \times \mathcal{M} \rightarrow \bin^n \\
    \xi_{K_H, T}(L||R) =& R \boxplus H_{K_H}(T, L) \\
    \vphantom{|} \\
    \phi :& \mathcal{K}_H \times \mathcal{T} \times \mathcal{M} \rightarrow \mathcal{M} \\
    \phi_{K_H, T}(L || R) =& L || \xi_{K_H, T}(L||R) \\
    =& L || (R \boxplus H_{K_H}(T, L)) \\
    \phi^{-1}_{K_H, T}(L || R) =& L || (R \boxminus H_{K_H}(T, L)) \\
    \vphantom{|} \\
    \theta :& \Perm(\bin^n) \times (\mathcal{N} \rightarrow \bin^{l_S}) \times \mathcal{M} \rightarrow \mathcal{M} \\
    \theta_{\pi, F}(L || R) =& (L \arrowoplus F(\pi(R))) || \pi(R) \\
    \vphantom{|} \\
    \eta :& \mathcal{K}_H \times \Perm(\bin^n) \times (\mathcal{N} \rightarrow \bin^{l_S}) \times \mathcal{T} \times \mathcal{M} \rightarrow \mathcal{M} \\
    \eta_{K_H, \pi, F, T} =& \phi_{K_H,T}^{-1} \circ \theta_{\pi, F} \circ \phi_{K_H,T} \\
\end{align*}

\parintro{H-coefficient technique}
We begin by using the ``H-coefficient'' technique to prove a distinguishing bound
between random query responses and
an ``idealized'' version of HBSH that uses a random function and permutation
in place of pseudorandom primitives.

The H-coefficient technique was introduced by Patarin in 1991~\cite{hco}; for definitions
of the terms, symbols, and inequalities we rely on here, see \cite{hco2} Section 3,
``The H-coefficient Technique in a Nutshell''.
As per that description, WLOG we assume a deterministic adversary $A$. An oracle $\omega$ is
sampled from a distribution of oracles, either $\Omega_X$ or
$\Omega_Y$ as appropriate; the transcript $\tau$ is then completely determined by the combination
of attacker and probabilistically chosen deterministic oracle.

\parintro{Transcript}
Our transcript $\tau$ is a sequence of tuples
$(d^i, T^i, P^i, C^i)$
in
$\{+, -\} \times \mathcal{T} \times \mathcal{M} \times \mathcal{M}$
for $i \in [0 \ldots q-1]$;
for the $i$th sequential query
$d^i$ is the direction of the query;
if $d^i = +$ then the left oracle is queried with $T^i, P^i$ and the result is $C^i$,
while if $d^i = -$ then the left oracle is queried with $T^i, C^i$ and the result is $P^i$.

\parintro{Allowed queries}
We consider adversaries contained in $\mathcal{A}(q, l_T, l_M, t)$ for some value of
the bounds $q$, $l_T$, $l_M$, $t$.
Without loss of generality, we consider only adversaries who do not make ``pointless''
queries as defined in \cite{cmc}. Thus for $i < j$, if $d^j = +$ then
$(T^j, P^j) \neq (T^i, P^i)$, and similarly if $d^j = -$ then
$(T^j, C^j) \neq (T^i, C^i)$.

\parintro{Ideal world}
Let $\LP^\mathcal{T}(\mathcal{M})$ denote the set of all
tweakable length-preserving functions
$\bm{f} : \mathcal{T} \times \mathcal{M} \rightarrow \mathcal{M}$
such that for all $T, M \in \mathcal{T} \times \mathcal{M}$,
$|\bm{f}(T, M)| = |M|$;
this is the definition of $\Perm^\mathcal{T}(\mathcal{M})$ with
the requirement for bijectivity on $\mathcal{M}$ removed.

Our ``ideal world''
is then a pair of such functions
$\omega = \mathcal{E}, \mathcal{D}$
sampled fairly from
$\Omega_Y = \LP^\mathcal{T}(\mathcal{M}) \times \LP^\mathcal{T}(\mathcal{M})$.
$Y$ is a random variable representing the distribution of transcripts for
$A^{\mathcal{E}, \mathcal{D}}$.

\parintro{Real world}
Our ``real world'' is an idealized form of HBSH which uses a random function and permutation:
$\omega = K_H, \pi, F$
sampled fairly from
$\Omega_X = \mathcal{K}_H \times \Perm(\bin^n) \times (\mathcal{N} \rightarrow \bin^{l_S})$.
$X$ is a random variable representing the distribution of transcripts for
$A^{\eta_{K_H, \pi, F}, \eta_{K_H, \pi, F}^{-1}}$.

\parintro{Bad events}
We define two bad events $\badQ$ and $\badR$.

\begin{itemize}
    \item $(K_H, \tau) \in \badQ$ if there exists $i < j$ such that
    \begin{itemize}
        \item either $d^j = +$ and $\xi(K_H, T^i, P^i) = \xi(K_H, T^j, P^j)$
        \item or $d^j = -$ and $\xi(K_H, T^i, C^i) = \xi(K_H, T^j, C^j)$.
    \end{itemize}
    \item $(K_H, \tau) \in \badR$ if there exists $i < j$ such that
    \begin{itemize}
        \item either $d^j = -$ and $\xi(K_H, T^i, P^i) = \xi(K_H, T^j, P^j)$
        \item or $d^j = +$ and $\xi(K_H, T^i, C^i) = \xi(K_H, T^j, C^j)$.
    \end{itemize}
\end{itemize}

Finally we define the disjunction
$\bad = \badQ \cup \badR$.

\subsection{Lemmas}
\begin{lemma} \label{badQ}
    For any $\tau$ such that $\prob{Y = \tau} > 0$,
    \begin{displaymath}
        \probsub{K_H \sample \mathcal{K}_H}{(K_H, \tau) \in \badQ}
        \leq \epsilon \binom{q}{2}
    \end{displaymath}
\end{lemma}

\begin{proof}
For any pair $i, j$, if $d^j = +$ then let $L^i || R^i = P^i$ and similarly for $P^j$.
\begin{align*}
    &\xi(K_H, T^i, L^i||R^i) = \xi(K_H, T^j, L^j||R^j) \\
    \Leftrightarrow& R^i \boxplus H_{K_H}(T^i, L^i) = R^j \boxplus H_{K_H}(T^j, L^j) \\
    \Leftrightarrow& H_{K_H}(T^i, L^i) \boxminus H_{K_H}(T^j, L^j) = R^j \boxminus R^i \\
\end{align*}
From $\prob{Y = \tau} > 0$ we know that $|T^i|, |T^j| \leq l_T$ and $|P^i|, |P^j| \leq l_M$,
and therefore that $|L^i|, |L^j| \leq l_M - n$.
Because pointless queries are forbidden we also know that $(T^i, P^i) \neq (T^j, P^j)$.
If $(T^i, L^i) = (T^j, L^j)$ then $R^i \neq R^j$ and the above equality doesn't occur.
Otherwise by the $\epsilon$A$\Delta$U property of $H$ this occurs with probability
at most $\epsilon$.
A similar argument applies for $C^i$, $C^j$ where $d^j = -$.
For an upper bound, we sum across all $\binom{q}{2}$ pairs $i, j$.
\end{proof}

\begin{lemma} \label{badR}
    For any $K_H \sample \mathcal{K}_H$,
    \begin{displaymath}
        \probsub{\tau \sim Y}{(K_H, \tau) \in \badR}
        \leq 2^{-n} \binom{q}{2}
    \end{displaymath}
\end{lemma}

\begin{proof}
    For any pair $i, j$, if $d^j = +$ then let $L^i || R^i = C^i$ and similarly for $C^j$.
    Because pointless queries are forbidden, in $Y$ world,
    conditioning on all prior queries and responses,
    all possible values of $C^j$ such that $|C^j| = |P^j|$ will be equally likely.
    In particular, all values of $R^j$ are equally likely. Therefore
    $\prob{R^j = R^i \boxplus H_{K_H}(T^i, L^i) \boxminus H_{K_H}(T^j, L^j)} = 2^{-n}$.
    A similar argument applies for $C^i$, $C^j$ where $d^j = -$.
    For an upper bound, we sum across all $\binom{q}{2}$ pairs $i, j$.
\end{proof}

\begin{lemma} \label{notbad}
    For any $K_H \in \mathcal{K}_H$ and transcript $\tau$ such that $\prob{Y = \tau} > 0$ and
    $(K_H, \tau) \notin \bad$,
    \begin{displaymath}
        \condprobsub{\Omega_X}{\omega \in \comp_X(\tau)}{\omega = (K_H, ., .)}
        \geq
        \probsub{\Omega_Y}{\omega \in \comp_Y(\tau)}
    \end{displaymath}
\end{lemma}

\begin{proof}
    In the $Y$ world, for any transcript such that $\prob{Y = \tau} > 0$,
    since all queries are distinct, the responses are independent of all
    previous responses, and
    $\probsub{\Omega_Y}{\omega \in \comp_Y(\tau)} = \prod_i 2^{-|P^i|}$.
    Let $P_L^i || P_R^i = P^i$, $P_M^i = \xi_{K_H, T^i}(P^i)$ and similarly for $C^i$.
    Since $(K_H, \tau) \notin \bad$ we have that $P_M^i \neq P_M^j$
    and $C_M^i \neq C_M^j$ for all $i \neq j$.

    \begin{align*}
        & \eta_{K_H, \pi, F, T^i}(P^i) = C^i\\
        \Leftrightarrow & \phi_{K_H,T^i}^{-1}(\theta_{\pi, F}(\phi_{K_H,T^i}(P^i))) = C^i\\
        \Leftrightarrow & \theta_{\pi, F}(P_L^i || P_M^i) = C_L^i || C_M^i \\
        \Leftrightarrow & \pi(P_M^i) = C_M^i \wedge F(C_M^i)[0;|P^i| - n] = P_L^i \oplus C_L^i \\
    \end{align*}

    These conditions are independent, since they depend on independently drawn
    variables:
    \begin{displaymath}
        \probsub{
            F \sample (\mathcal{N} \rightarrow \bin^{l_S})
        }{
            \forall_i : F(C_M^i)[0;|P^i| - n] = P_L^i \oplus C_L^i
        } = \prod_i 2^{-(|P^i| - n)}
    \end{displaymath}
    and
    \begin{displaymath}
        \probsub{
            \pi \sample \Perm(\bin^n)
        }{
            \forall_i : \pi(P_M^i) = C_M^i
        } = \prod_i \frac{1}{2^n - i}
    \end{displaymath}

    Therefore:
    \begin{align*}
        &\condprobsub{\Omega_X}{\omega \in \comp_X(\tau)}{\omega = (K_H, ., .)} \\
        =& \probsub{
            \pi \sample \Perm(\bin^n),
            F \sample (\mathcal{N} \rightarrow \bin^{l_S})
        }{
            \forall_i : \eta_{K_H, \pi, F, T^i}(P^i) = C^i
        } \\
        =& \prod_i \frac{1}{2^n - i}2^{-(|P^i| - n)} \\
        \geq & \prod_i 2^{-|P^i|} = \probsub{\Omega_Y}{\omega \in \comp_Y(\tau)}\\
    \end{align*}
\end{proof}

\begin{lemma} \label{xyadv}
    \begin{displaymath}
        \advantage{\pm \widetilde{\mathrm{rnd}}}{\eta}[(q, l_T, l_M, t)]
        \leq (\epsilon + 2^{-n})\binom{q}{2}
    \end{displaymath}
\end{lemma}

\begin{proof}
    $\advantage{\pm \widetilde{\mathrm{rnd}}}{\eta}[(q, l_T, l_M, t)]
    = \max_{A \in \mathcal{A}(q, l_T, l_M, t)} |\rho_X - \rho_Y|$ where
    \begin{align*}
        \rho_X =& \condprob{A^{\eta_{K_H, \pi, F}, \eta_{K_H, \pi, F}^{-1}}\Rightarrow 1}{K_H, \pi, F \sample \Omega_X} \\
        \rho_Y =& \condprob{A^{\mathcal{E}, \mathcal{D}}\Rightarrow 1}{\mathcal{E}, \mathcal{D} \sample \Omega_Y} \\
    \end{align*}

    Applying the H-coefficient technique:
    \begin{align*}
        &|\rho_X - \rho_Y| \\
        \leq& 1 - \expsub{\tau \sim Y}{\min
            \left(1,
               \frac{\probsub{\Omega_X}{\omega \in \comp_X(\tau)}}
               {\probsub{\Omega_Y}{\omega \in \comp_Y(\tau)}}
            \right)} \\
        =& 1 - \expsub{\tau \sim Y}{\min
            \left(1, \sum_{K_H \in \mathcal{K}_H}
              \frac{\probsub{\Omega_X}{\omega \in \comp_X(\tau) \wedge \omega = (K_H, ., .)}}
              {\probsub{\Omega_Y}{\omega \in \comp_Y(\tau)}}
            \right)} \\
        \intertext{by \autoref{notbad}}
        \leq& 1 - \expsub{\tau \sim Y}{
            \probsub{K_H \in \mathcal{K}_H}{(K_H, \tau) \notin \bad}} \\
        = & \probsub{\tau \sim Y, K_H \in \mathcal{K}_H}{(K_H, \tau) \in \bad} \\
        \leq & \probsub{\tau \sim Y, K_H \in \mathcal{K}_H}{(K_H, \tau) \in \badQ}
         + \probsub{\tau \sim Y, K_H \in \mathcal{K}_H}{(K_H, \tau) \in \badR} \\
         \intertext{by \autoref{badQ} and \autoref{badR}}
        \leq & (\epsilon + 2^{-n})\binom{q}{2} \\
    \end{align*}
\end{proof}

\subsection{Main proof}
\begin{proof}[Proof of \autoref{hbshadvantage}]
    To prove this theorem we need a bound on $|\rho_V - \rho_Z|$
    where
    \begin{align*}
        \rho_V =& \condprob{A^{\HBSH_{K_S}, \HBSH_{K_S}^{-1}}\Rightarrow 1}{K_S \sample \mathcal{K}_S} \\
        \rho_Z =& \condprob{A^{\bm{\pi},\bm{\pi}^{-1}}\Rightarrow 1}{\bm{\pi} \sample \Perm^\mathcal{T}(\mathcal{M})} \\
    \end{align*}

    \autoref{xyadv} bounds $|\rho_X - \rho_Y|$.
    Since we forbid pointless queries,
    $|\rho_Y - \rho_Z| \leq 2^{-n}\binom{q}{2}$ by Halevi and Rogaway's PRP-RND lemma
    (\cite{cmc}, appendix C, lemma 6).

    To bound $|\rho_X - \rho_V|$ we introduce
    a stepping stone. Let $\bar{\eta}_{F} = \eta_{K_H, E_{K_E}, F}$ where
    $E$ is a block cipher and $K_E || K_H || \ldots = F(\lambda)$. Define
    \begin{align*}
        \rho_W =& \condprob{A^{\bar{\eta}_{F}, \bar{\eta}_{F}^{-1}}\Rightarrow 1}{F \sample (\mathcal{N} \rightarrow \bin^{l_S})} \\
    \end{align*}

    Note that $\HBSH_{K_S} = \bar{\eta}_{S_{K_S}}$, so distinguishing
    $\rho_V$ and $\rho_W$ is just distinguishing the substitution of a PRF
    for a random function.
    Including the key schedule, the attacker distinguishing
    $\rho_V$ and $\rho_W$ makes at most $q + 1$ queries on the stream cipher
    or random function respectively, and uses at most $|K_E| + |K_H| + q(l_M - n)$ bits
    of the output; by a standard substitution argument
    $|\rho_V - \rho_W| \leq \advantage{\mathrm{prf}}{S}[(q + 1, |K_E| + |K_H| + q(l_M - n), t')]$ where $t' = t + \bigO{q(l_T + l_M)}$.

    The differences between $\rho_W$ and $\rho_X$ are the use of a block cipher
    in place of a random permutation, and the use of $F(\lambda)$ to determine
    $K_E$ and $K_H$. Since $F$ is a random function and $F(\lambda)$ is used
    only here, this is equivalent to choosing them at random; again by a substitution
    argument we have that $|\rho_W - \rho_X| \leq \advantage{\pm \mathrm{prp}}{E}[(q, t')]$.

    \autoref{hbshadvantage} follows by summing these bounds:
    $|\rho_V - \rho_Z| \leq |\rho_V - \rho_W| + |\rho_W - \rho_X| + |\rho_X - \rho_Y| + |\rho_Y - \rho_Z|$.
\end{proof}

\subbib
\end{document}
